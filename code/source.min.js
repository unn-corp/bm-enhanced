let EXTENSION_VERSION="3.00",bmORG_ID=58064,SOURCES={adminList:"https://raw.githubusercontent.com/Synarious/bm-enhanced/refs/heads/unnamed/config/adminList.json",customConfig:"https://raw.githubusercontent.com/Synarious/bm-enhanced/refs/heads/unnamed/config/termList.json"},SELECTORS={logContainer:".ReactVirtualized__Grid__innerScrollContainer, .css-b7r34x",logMessages:".css-ym7lu8",logPlayerNames:".css-1ewh5td",logActivityNames:".css-fj458c",logNoteFlags:".css-he5ni6",logServerNames:".css-1ymmsk5",logTimestamps:".css-z1s6qn",logTimestampsLong:".css-1jtoyp",playerPage:"#RCONPlayerPage",playerPageTitle:"#RCONPlayerPage h2",playerInfoTable:"#RCONPlayerPage table.css-11gv980",orgEditPage:"#RCONOrgEditPage",orgRoleList:"#RCONOrgEditPage ul.list-unstyled > li",banButton:'a[href="/rcon/bans"]',cornerButtonContainer:"#corner-button-container",actionsContainer:"#bmus-actions-container",copyInfoButton:"#copy-player-info-btn",cblInfoContainer:"#CBL-info-container"};(async()=>{let o=1;function c(e,...t){e<=o&&console.log("BMUS_LOG |",...t)}let d={config:null,adminLists:{group1:new Set,group2:new Set,group3:new Set},page:{isPlayerPage:!1,isLogView:!1,isOrgEditPage:!1}};async function u(e,t,o={}){try{var n,r=await fetch(e,o);if(429===r.status)return console.warn(`â³|BMUS: Rate limited when fetching ${t}. Status: 429`),null;if(r.ok)return(n=await r.text())?JSON.parse(n):null;throw new Error(`HTTP error! Status: ${r.status} for `+t)}catch(e){return console.error(`ðŸš«|BMUS: Failed to fetch ${t}.`,e),null}}function n(e,t,o){let n=document.createElement("div");Object.assign(n.style,{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:"rgba(19, 19, 19, 0.85)",color:"white",zIndex:"99999",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",fontSize:"2rem",fontWeight:"bold",textAlign:"center",backdropFilter:"blur(5px)"}),n.innerHTML=`<div>ðŸš¨ Battlemetrics - Chrome Extension Version Warning ðŸš¨<br><br><div style="font-size: 1.5rem; max-width: 800px;">${o}</div><br><br>Local version: <span style="color: yellow">${e}</span> /// Remote version: <span style="color: cyan">${t}</span><br><br><button id="closeWarningBtn" style="padding: 10px 20px; font-size: 1rem; background: white; color: red; border: none; cursor: pointer; border-radius: 5px;">Ignore Warning & Close</button></div>`,document.body.appendChild(n),document.getElementById("closeWarningBtn").addEventListener("click",()=>n.remove())}function r(){if(d.config){let{sets:e,colors:t,serverName1:o,serverName2:n}=d.config;[{elements:document.querySelectorAll(SELECTORS.logMessages),set:e.joinedServer,color:t.cJoined},{elements:document.querySelectorAll(SELECTORS.logMessages),set:e.leftServer,color:t.cLeftServer},{elements:document.querySelectorAll(SELECTORS.logMessages),set:e.actionList,color:t.cModAction},{elements:document.querySelectorAll(SELECTORS.logMessages),set:e.adminTerms,color:t.cAdminAction},{elements:document.querySelectorAll(SELECTORS.logMessages),set:e.factionGroup1,color:t.cFactionGroup1},{elements:document.querySelectorAll(SELECTORS.logMessages),set:e.factionGroup2,color:t.cFactionGroup2},{elements:document.querySelectorAll(SELECTORS.logMessages),set:e.factionGroup3,color:t.cFactionGroup3},{elements:document.querySelectorAll(SELECTORS.logMessages),set:e.teamKilled,color:t.cTeamKilled},{elements:document.querySelectorAll(SELECTORS.logMessages),set:e.trackedTriggers,color:t.cTracked},{elements:document.querySelectorAll(SELECTORS.logMessages),set:e.grayedOut,color:t.cGrayed}].forEach(({elements:e,set:o,color:n})=>e.forEach(e=>{if(!e.dataset.colored)for(var t of o)if(e.textContent.includes(t)){e.style.color=n,e.dataset.colored="true";break}}));var r=document.querySelectorAll(SELECTORS.logActivityNames+", "+SELECTORS.logPlayerNames),r=[{elements:r,list:d.adminLists.group1,color:t.cStaffGroup1},{elements:r,list:d.adminLists.group2,color:t.cStaffGroup2},{elements:r,list:d.adminLists.group3,color:t.cStaffGroup3}],a=d.config.namePrefixes||[],s=a.map(e=>l(e)).join("|");let i=0<a.length?`(?:(?:${s})\\s*)?`:"";r.forEach(({elements:e,list:n,color:r})=>{e.forEach(e=>{if(!e.dataset.colored){var t,o=e.textContent.trimStart();for(t of n)if(new RegExp(`^${i}${l(t)}$`).test(o)){e.style.color=r,e.dataset.colored="true";break}}})});{a=document.querySelectorAll(SELECTORS.logTimestamps+", "+SELECTORS.logTimestampsLong);let o={weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"2-digit",second:"2-digit",timeZoneName:"short",hour12:!0};a.forEach(e=>{if(e.title&&e.title.includes(":")&&2<e.title.split(":").length)return;var t=e.getAttribute("datetime");t&&(t=new Date(t),isNaN(t.getTime())||e.setAttribute("title",t.toLocaleString(void 0,o)))})}function l(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}document.querySelectorAll(SELECTORS.logServerNames).forEach(e=>{e.dataset.colored||(e.textContent.includes(o)?e.style.color="green":e.textContent.includes(n)&&(e.style.color="yellow"),e.dataset.colored="true")}),document.querySelectorAll(SELECTORS.logNoteFlags).forEach(e=>e.style.color=t.cNoteColorIcon)}}async function i(){if(c(2,"setupPlayerPage() called."),!d.page.isPlayerPage){var o=document.querySelector(SELECTORS.playerInfoTable);if(o){c(1,"Identifiers table found. Proceeding with player page setup.");let e=null;var n,r,i,a,o=o.querySelectorAll("tbody > tr");c(2,`Found ${o.length} identifier rows. Searching for valid Steam ID...`);for(n of o){var s=n.querySelector('td[data-title="Type"] div.css-18s4qom'),l=n.querySelector('td[data-title="Identifier"] span');if(s&&l&&"Steam ID"===s.textContent.trim()){s=l.textContent.trim();if(s.startsWith("765")){c(2,"Valid Steam ID found for CBL: "+(e=s));break}}}d.page.isPlayerPage=!0;let t=document.querySelector(SELECTORS.actionsContainer);t||(c(2,"Creating actions container."),(t=document.createElement("div")).id=SELECTORS.actionsContainer.substring(1),document.body.appendChild(t)),document.querySelector(SELECTORS.copyInfoButton)||(c(2,"Creating Copy button."),(o=document.createElement("button")).id=SELECTORS.copyInfoButton.substring(1),o.textContent="ðŸ“‹ Copy",o.title="Copy Player Info",o.addEventListener("click",m),t.appendChild(o)),document.querySelector(SELECTORS.cblInfoContainer)||(c(2,"Creating CBL element..."),e?((o=document.createElement("a")).id=SELECTORS.cblInfoContainer.substring(1),o.href="https://communitybanlist.com/search/"+e,o.target="_blank",o.rel="noopener noreferrer",o.title=`View ${e} on Community Ban List`,o.innerHTML="<span>Loading CBL...</span>",t.appendChild(o),c(2,"Calling fetchCBLData()."),i=e,o=o,i={query:"query Search($id: String!) { steamUser(id: $id) { riskRating, activeBans: bans(expired: false) { edges { node { id } } }, expiredBans: bans(expired: true) { edges { node { id } } } } }",variables:{id:i}},c(3,"CBL Response Data:",i=await u("https://communitybanlist.com/graphql","CBL GraphQL",i={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})),i?.data?.steamUser?(i=i.data.steamUser,a=i.riskRating??0,r=i.activeBans?.edges?.length??0,i=i.expiredBans?.edges?.length??0,o.innerHTML=`<span style="color: ${5<a?"red":0<a?"orange":"white"};">CBL: ${a}/10</span> | <span>Act: ${r}</span> | <span>Exp: ${i}</span>`):o.innerHTML="<span>CBL: Not Found</span>"):((a=document.createElement("div")).id=SELECTORS.cblInfoContainer.substring(1),a.innerHTML="<span>CBL: SteamID not found</span>",t.appendChild(a),c(1,"Warning: No valid SteamID starting with '765' was found for CBL.")))}else c(2,"setupPlayerPage: Identifiers table NOT found yet.")}}function m(){c(2,"--- Starting copyPlayerInfo ---");var e=document.querySelector(SELECTORS.playerInfoTable);if(e){e=e.querySelectorAll("tbody > tr");let r=[];e.forEach((e,t)=>{var o=e.querySelector('td[data-title="Identifier"] span'),n=e.querySelector('td[data-title="Type"] div.css-18s4qom'),e=e.querySelector('td[data-title="Last Seen"] time');o&&n&&e?r.push({value:o.textContent.trim(),type:n.textContent.trim(),timestamp:new Date(e.getAttribute("datetime"))}):c(2,`Warning: Failed to parse row ${t}.`)}),c(3,"Parsed all identifiers:",r),r.sort((e,t)=>t.timestamp-e.timestamp),c(3,"Sorted all identifiers by timestamp:",r);var t,o=new Map;for(t of r)o.has(t.type)||o.set(t.type,t.value);c(2,"Selected unique, most recent identifiers:",o);var n,i=[];for(n of["Name","Steam ID","EOS ID"])o.has(n)&&i.push(n+": "+o.get(n));i.push(`BM: <${window.location.href}>`);e=i.join("\n");c(3,"--- Final string to be copied: ---\n"+e),navigator.clipboard.writeText(e).then(()=>c(1,"âœ… Player info copied!")).catch(e=>console.error("ðŸš«|BMUS: Clipboard copy failed",e))}else console.error("BMUS_ERROR: Could not find identifiers table for copy action.")}function a(){var e,t;c(3,"DOM Change Detected, running checks..."),document.querySelector(SELECTORS.playerPage)?i():d.page.isPlayerPage&&(c(1,"Left player page, cleaning up."),document.querySelector(SELECTORS.actionsContainer)?.remove(),d.page.isPlayerPage=!1),document.querySelector(SELECTORS.logContainer)&&r(),document.querySelector(SELECTORS.orgEditPage)?(d.page.isOrgEditPage||(c(2,"Setting up Organization Edit Page..."),d.page.isOrgEditPage=!0),document.querySelectorAll(SELECTORS.orgRoleList).forEach(e=>{var t;e.dataset.modified||((t=Array.from(e.childNodes).find(e=>e.nodeType===Node.TEXT_NODE&&""!==e.textContent.trim()))&&e.insertBefore(document.createTextNode(" ||| "),t.nextSibling),e.dataset.modified="true")})):d.page.isOrgEditPage=!1,(t=document.querySelector(SELECTORS.banButton))&&!t.dataset.modified&&(c(2,"Found original ban button. Overriding its click behavior..."),(e=t.cloneNode(!0)).href="/rcon/bans?filter%5Borganization%5D="+bmORG_ID,e.dataset.modified="true",t.parentNode.replaceChild(e,t),c(1,"Ban button link successfully overridden."))}(async()=>{c(1,`ðŸš€ BMUS v${EXTENSION_VERSION}: Initializing...`);var[e,t]=await Promise.all([u(SOURCES.customConfig,"Custom Config"),u(SOURCES.adminList,"Admin List")]);e?(d.config=e,(e=d.config?.chrome_extension_version)?e!==EXTENSION_VERSION?n(EXTENSION_VERSION,e,`Your script version is out of date. Please update.
Config URL: `+SOURCES.customConfig):c(1,`Extension version (${EXTENSION_VERSION}) is up to date.`):n(EXTENSION_VERSION,"Unavailable",`Remote version is missing from config.
URL: `+SOURCES.customConfig),t&&(d.adminLists.group1=new Set(t.group1),d.adminLists.group2=new Set(t.group2),d.adminLists.group3=new Set(t.group3),c(2,"Admin lists loaded.")),document.getElementById("bmus-global-styles")||((e=document.createElement("style")).id="bmus-global-styles",e.textContent="#bmus-actions-container{position:absolute;top:14.35em;left:19em;z-index:1000;display:flex;align-items:center}#copy-player-info-btn{padding:4px;width:75px;background:rgb(0, 123, 255);color:white;border:none;border-radius:5px;cursor:pointer}#CBL-info-container{margin-left:10px;padding:4px 8px;background:#000000bd;color:white;border-radius:5px;font-size:14px;font-weight:bold;white-space:nowrap;text-decoration:none;transition:filter 0.2s}#CBL-info-container:hover{filter: brightness(1.2)}.main{width:90% !important;margin-left:4em;margin-right:4em}@media (max-width: 768px){.main{width:inherit !important}}.css-1nxi32t{width:1px}.css-1xkypod{position:unset !important}.css-mxzvlz{padding-left:0.5em;width:20%;display:inline-table}.css-110bni0{font-size:14px}@media (max-width: 1099px) and (min-width: 950px){.css-mxzvlz{width:33%;display:inline-table}}@media (max-width: 949px) and (min-width: 601px){.css-mxzvlz{width:50%;display:inline-table}}@media (max-width: 600px){.css-mxzvlz{width:100%;display:inline-table}}",document.head.appendChild(e),c(2,"Global CSS injected.")),document.querySelector(SELECTORS.cornerButtonContainer)||((t=document.createElement("div")).id=SELECTORS.cornerButtonContainer.substring(1),Object.assign(t.style,{position:"fixed",bottom:"10px",right:"10px",zIndex:"99999"}),(e=document.createElement("button")).textContent="v"+EXTENSION_VERSION,Object.assign(e.style,{background:"black",color:"white",border:"1px solid white",borderRadius:"5px",padding:"5px",fontSize:"10px",cursor:"pointer"}),t.appendChild(e),document.body.appendChild(t),c(2,"Corner buttons set up.")),new MutationObserver(a).observe(document.body,{childList:!0,subtree:!0}),a(),c(1,"ðŸ‘€ Observer is active.")):n(EXTENSION_VERSION,"Error",`Could not load required configuration from:
`+SOURCES.customConfig)})()})();