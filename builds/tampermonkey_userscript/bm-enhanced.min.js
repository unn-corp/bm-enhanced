// ==UserScript==
// @name Battlemetrics Toolkit - Desktop
// @namespace https://www.battlemetrics.com/
// @version 3.01
// @updateURL https://raw.githubusercontent.com/Synarious/bm-enhanced/unnamed/builds/tampermonkey_userscript/bm-enhanced.min.js
// @downloadURL https://raw.githubusercontent.com/Synarious/bm-enhanced/unnamed/builds/tampermonkey_userscript/bm-enhanced.min.js
// @description Modifies the rcon panel for battlemetrics to help color code important events and details about players.
// @author Synarion (aka Synarious @ syfusion.com/github)
// @match https://www.battlemetrics.com/*
// @match https://www.battlemetrics.com
// @icon https://www.google.com/s2/favicons?sz=64&domain=battlemetrics.com
// @grant GM_addStyle
// @grant GM_xmlhttpRequest
// @connect communitybanlist.com
// @run-at document-end
// ==/UserScript==
const e="3.01",t=58064,n={adminList:"https://raw.githubusercontent.com/Synarious/bm-enhanced/refs/heads/unnamed/src/config/adminList.json",customConfig:"https://raw.githubusercontent.com/Synarious/bm-enhanced/refs/heads/unnamed/src/config/termList.json"},o={logContainer:".ReactVirtualized__Grid__innerScrollContainer, .css-b7r34x",logMessages:".css-ym7lu8",logPlayerNames:".css-1ewh5td",logActivityNames:".css-fj458c",logNoteFlags:".css-he5ni6",logServerNames:".css-1ymmsk5",logTimestamps:".css-z1s6qn",logTimestampsLong:".css-1jtoyp",playerPage:"#RCONPlayerPage",playerPageTitle:"#RCONPlayerPage h2",playerInfoTable:"#RCONPlayerPage table.css-11gv980",orgEditPage:"#RCONOrgEditPage",orgRoleList:"#RCONOrgEditPage ul.list-unstyled > li",banButton:'a[href="/rcon/bans"]',cornerButtonContainer:"#corner-button-container",actionsContainer:"#bmus-actions-container",copyInfoButton:"#copy-player-info-btn",cblInfoContainer:"#CBL-info-container"};(async()=>{const r={config:null,adminLists:{group1:new Set,group2:new Set,group3:new Set},page:{isPlayerPage:!1,isLogView:!1,isOrgEditPage:!1}};function i(e,...t){e<=1&&console.log("BMUS_LOG |",...t)}async function a(e,t,n={}){try{const o=await fetch(e,n);if(429===o.status)return console.warn(`â³|BMUS: Rate limited when fetching ${t}. Status: 429`),null;if(!o.ok)throw new Error(`HTTP error! Status: ${o.status} for ${t}`);const r=await o.text();return r?JSON.parse(r):null}catch(e){return console.error(`ðŸš«|BMUS: Failed to fetch ${t}.`,e),null}}function s(e,t,n){const o=document.createElement("div");Object.assign(o.style,{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:"rgba(19, 19, 19, 0.85)",color:"white",zIndex:"99999",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",fontSize:"2rem",fontWeight:"bold",textAlign:"center",backdropFilter:"blur(5px)"}),o.innerHTML=`<div>ðŸš¨ Battlemetrics - Chrome Extension Version Warning ðŸš¨<br><br><div style="font-size: 1.5rem; max-width: 800px;">${n}</div><br><br>Local version: <span style="color: yellow">${e}</span> /// Remote version: <span style="color: cyan">${t}</span><br><br><button id="closeWarningBtn" style="padding: 10px 20px; font-size: 1rem; background: white; color: red; border: none; cursor: pointer; border-radius: 5px;">Ignore Warning & Close</button></div>`,document.body.appendChild(o),document.getElementById("closeWarningBtn").addEventListener("click",()=>o.remove())}function c(e,t){const n=function({adminLists:e,config:t}){const n=new Map,o=[{list:e.group1,color:t.colors.cStaffGroup1},{list:e.group2,color:t.colors.cStaffGroup2},{list:e.group3,color:t.colors.cStaffGroup3}];for(const{list:e,color:t}of o)if(e&&t)for(const o of e)n.set(o.trim(),t);return n}(t);if(0===n.size)return;const o=t.config.namePrefixes||[];e.forEach(e=>{if(e.dataset.colored)return;const t=e.textContent.trim();let r;if(r=n.get(t),!r)for(const e of o)if(t.startsWith(e)){const o=t.substring(e.length).trim();if(r=n.get(o),r)break}r&&(e.style.color=r,e.dataset.colored="true")})}function l(){if(!r.config)return;const e=document.querySelectorAll(o.logMessages),t=document.querySelectorAll(`${o.logActivityNames}, ${o.logPlayerNames}`),n=document.querySelectorAll(o.logServerNames),i=document.querySelectorAll(o.logNoteFlags);!function(e,{sets:t,colors:n}){const o=[{regex:/(?:\s|:|"|^)!admin/i,backgroundColor:"#9a000040",color:"lime"},{phrases:t.teamKilled,color:n.cTeamKilled,backgroundColor:"#292135"},{phrases:t.joinedServer,color:n.cJoined},{phrases:t.leftServer,color:n.cLeftServer},{phrases:t.actionList,color:n.cModAction},{phrases:t.adminTerms,color:n.cAdminAction},{phrases:t.coloredGroup1,color:n.cColoredGroup1},{phrases:t.coloredGroup2,color:n.cColoredGroup2},{phrases:t.coloredGroup3,color:n.cColoredGroup3},{phrases:t.trackedTriggers,color:n.cTracked},{phrases:t.grayedOut,color:n.cGrayed}];e.forEach(e=>{const t=e.parentElement;if(!t||t.dataset.styled)return;const n=e.textContent;for(const r of o)if(r.regex?r.regex.test(n.trim()):r.phrases.some(e=>n.includes(e))){r.color&&(e.style.color=r.color),r.backgroundColor&&(t.style.backgroundColor=r.backgroundColor),t.dataset.styled="true";break}})}(e,r.config),c(t,r);const{serverName1:a,serverName2:s,colors:l}=r.config;n.forEach(e=>{if(e.dataset.colored)return;const t=e.textContent;t.includes(a)?e.style.color="green":t.includes(s)&&(e.style.color="yellow"),e.dataset.colored="true"}),i.forEach(e=>{e.style.color||(e.style.color=l.cNoteColorIcon)}),function(){const e=document.querySelectorAll(`${o.logTimestamps}, ${o.logTimestampsLong}`),t={weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"2-digit",second:"2-digit",timeZoneName:"short",hour12:!0};e.forEach(e=>{if(e.dataset.timestampApplied)return;const n=e.getAttribute("datetime");if(n){const o=new Date(n);isNaN(o.getTime())||(e.title=o.toLocaleString(void 0,t),e.dataset.timestampApplied="true")}})}()}function d(){i(2,"--- Starting copyPlayerInfo ---");const e=document.querySelector(o.playerInfoTable);if(!e)return void console.error("BMUS_ERROR: Could not find identifiers table for copy action.");const t=e.querySelectorAll("tbody > tr");let n=[];t.forEach((e,t)=>{const o=e.querySelector('td[data-title="Identifier"] span'),r=e.querySelector('td[data-title="Type"] div.css-18s4qom'),a=e.querySelector('td[data-title="Last Seen"] time');o&&r&&a?n.push({value:o.textContent.trim(),type:r.textContent.trim(),timestamp:new Date(a.getAttribute("datetime"))}):i(2,`Warning: Failed to parse row ${t}.`)}),i(3,"Parsed all identifiers:",n),n.sort((e,t)=>t.timestamp-e.timestamp),i(3,"Sorted all identifiers by timestamp:",n);const r=new Map;for(const e of n)r.has(e.type)||r.set(e.type,e.value);i(2,"Selected unique, most recent identifiers:",r);const a=[],s=["Name","Steam ID","EOS ID"];for(const e of s)r.has(e)&&a.push(`${e}: ${r.get(e)}`);a.push(`BM: <${window.location.href}>`);const c=a.join("\n");i(3,"--- Final string to be copied: ---\n"+c),navigator.clipboard.writeText(c).then(()=>i(1,"âœ… Player info copied!")).catch(e=>console.error("ðŸš«|BMUS: Clipboard copy failed",e))}async function u(){if(i(2,"setupPlayerPage() called."),r.page.isPlayerPage)return;const e=document.querySelector(o.playerInfoTable);if(!e)return void i(2,"setupPlayerPage: Identifiers table NOT found yet.");i(1,"Identifiers table found. Proceeding with player page setup.");let t=null;const n=e.querySelectorAll("tbody > tr");i(2,`Found ${n.length} identifier rows. Searching for valid Steam ID...`);for(const e of n){const n=e.querySelector('td[data-title="Type"] div.css-18s4qom'),o=e.querySelector('td[data-title="Identifier"] span');if(n&&o&&"Steam ID"===n.textContent.trim()){const e=o.textContent.trim();if(e.startsWith("765")){t=e,i(2,`Valid Steam ID found for CBL: ${t}`);break}}}r.page.isPlayerPage=!0;let s=document.querySelector(o.actionsContainer);if(s||(i(2,"Creating actions container."),s=document.createElement("div"),s.id=o.actionsContainer.substring(1),document.body.appendChild(s)),!document.querySelector(o.copyInfoButton)){i(2,"Creating Copy button.");const e=document.createElement("button");e.id=o.copyInfoButton.substring(1),e.textContent="ðŸ“‹ Copy",e.title="Copy Player Info",e.addEventListener("click",d),s.appendChild(e)}if(!document.querySelector(o.cblInfoContainer))if(i(2,"Creating CBL element..."),t){const e=document.createElement("a");e.id=o.cblInfoContainer.substring(1),e.href=`https://communitybanlist.com/search/${t}`,e.target="_blank",e.rel="noopener noreferrer",e.title=`View ${t} on Community Ban List`,e.innerHTML="<span>Loading CBL...</span>",s.appendChild(e),i(2,"Calling fetchCBLData()."),await async function(e,t){const n={query:"query Search($id: String!) { steamUser(id: $id) { riskRating, activeBans: bans(expired: false) { edges { node { id } } }, expiredBans: bans(expired: true) { edges { node { id } } } } }",variables:{id:e}},o={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)},r=await a("https://communitybanlist.com/graphql","CBL GraphQL",o);if(i(3,"CBL Response Data:",r),r?.data?.steamUser){const e=r.data.steamUser,n=e.riskRating??0,o=e.activeBans?.edges?.length??0,i=e.expiredBans?.edges?.length??0,a=n>5?"red":n>0?"orange":"white";t.innerHTML=`<span style="color: ${a};">CBL: ${n}/10</span> | <span>Act: ${o}</span> | <span>Exp: ${i}</span>`}else t.innerHTML="<span>CBL: Not Found</span>"}(t,e)}else{const e=document.createElement("div");e.id=o.cblInfoContainer.substring(1),e.innerHTML="<span>CBL: SteamID not found</span>",s.appendChild(e),i(1,"Warning: No valid SteamID starting with '765' was found for CBL.")}}function m(){i(3,"DOM Change Detected, running checks...");document.querySelector(o.playerPage)?u():r.page.isPlayerPage&&(i(1,"Left player page, cleaning up."),document.querySelector(o.actionsContainer)?.remove(),r.page.isPlayerPage=!1),document.querySelector(o.logContainer)&&l(),document.querySelector(o.orgEditPage)?(r.page.isOrgEditPage||(i(2,"Setting up Organization Edit Page..."),r.page.isOrgEditPage=!0),document.querySelectorAll(o.orgRoleList).forEach(e=>{if(e.dataset.modified)return;const t=Array.from(e.childNodes).find(e=>e.nodeType===Node.TEXT_NODE&&""!==e.textContent.trim());t&&e.insertBefore(document.createTextNode(" ||| "),t.nextSibling),e.dataset.modified="true"})):r.page.isOrgEditPage=!1,function(){const e=document.querySelector(o.banButton);if(e&&!e.dataset.modified){i(2,"Found original ban button. Overriding its click behavior...");const n=e.cloneNode(!0);n.href="/rcon/bans?filter%5Borganization%5D="+t,n.dataset.modified="true",e.parentNode.replaceChild(n,e),i(1,"Ban button link updated.")}}()}await async function(){i(1,`ðŸš€ BMUS v${e}: Initializing...`);const[t,o]=await Promise.all([a(n.customConfig,"Custom Config"),a(n.adminList,"Admin List")]);if(!t)return void s(e,"Error",`Could not load required configuration from:\n${n.customConfig}`);r.config=t;const c=r.config?.chrome_extension_version;c?c!==e?s(e,c,`Your script version is mismatched or outdated. Please update.\nConfig URL: ${n.customConfig}`):i(1,`Extension version (${e}) is up to date.`):s(e,"Unavailable",`Remote version is missing from config.\nURL: ${n.customConfig}`),o&&(r.adminLists.group1=new Set(o.group1),r.adminLists.group2=new Set(o.group2),r.adminLists.group3=new Set(o.group3),i(2,"Admin lists loaded.")),function(){if(document.getElementById("bmus-global-styles"))return;const e=document.createElement("style");e.id="bmus-global-styles",e.textContent="\n            #bmus-actions-container {\n                position: absolute;\n                top: 14.35em;\n                left: 19em;\n                z-index: 1000;\n                display: flex;\n                align-items: center;\n            }\n            #copy-player-info-btn {\n                padding: 4px;\n                width: 75px;\n                background: rgb(0,  123,  255);\n                color: white;\n                border: none;\n                border-radius: 5px;\n                cursor: pointer;\n            }\n            #CBL-info-container {\n                margin-left: 10px;\n                padding: 4px 8px;\n                background: #000000bd;\n                color: white;\n                border-radius: 5px;\n                font-size: 14px;\n                font-weight: bold;\n                white-space: nowrap;\n                text-decoration: none;\n                transition: filter 0.2s;\n            }\n            #CBL-info-container:hover {\n                filter:  brightness(1.2);\n            }\n            .main {\n                width: 90% !important;\n                margin-left: 4em;\n                margin-right: 4em;\n            }\n            @media (max-width: 768px) {\n                .main {\n                width: inherit !important;\n            }\n            }.css-1nxi32t {\n                width: 1px;\n            }\n            .css-1xkypod {\n                position: unset !important;\n            }\n            .css-mxzvlz {\n                padding-left: 0.5em;\n                width: 20%;\n                display: inline-table;\n            }\n            .css-110bni0 {\n                font-size: 14px;\n            }\n            @media (max-width: 1099px) and (min-width: 950px) {\n                .css-mxzvlz {\n                width: 33%;\n                display: inline-table;\n            }\n            }@media (max-width: 949px) and (min-width: 601px) {\n                .css-mxzvlz {\n                width: 50%;\n                display: inline-table;\n            }\n                \n            }@media (max-width: 600px) {\n                .css-mxzvlz {\n                width: 100%;\n                display: inline-table;\n            }\n        }",document.head.appendChild(e),i(2,"Global CSS injected.")}(),new MutationObserver(m).observe(document.body,{childList:!0,subtree:!0}),m(),i(1,"ðŸ‘€ Observer is active.")}()})();